name: Build/Test for PR and collaborator push

on:
  # allows us to run workflows manually
  workflow_dispatch:
  pull_request:
    paths-ignore:
      - '.github/workflows/build_test_publish.yml'
      - 'docker/**'
      - 'doc/**'
  push:
    paths-ignore:
      - '.github/workflows/build_test_publish.yml'
      - 'docker/**'
      - 'doc/**'

jobs:
  build-and-test:

    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        ubuntu_versions : [
          20.04,
          22.04
          ]
        pkg_mgr : [
            apt,
            conda
        ]
        cyclus_tag: [
          latest
        ]
    
    container:
      image: ghcr.io/cyclus/cyclus_${{ matrix.ubuntu_versions }}_${{ matrix.pkg_mgr }}/cyclus:${{matrix.cyclus_tag}}

    steps:
      - name: Checkout Cycamore
        uses: actions/checkout@v3

      - name: Echo stuff
        run: |
          echo PYTHONPATH=$PYTHONPATH
          echo LD_LIBRARY_PATH=$LD_LIBRARY_PATH

      - name: Build Cycamore
        run: |
          python install.py  --prefix=/root/.local -j 2 --build-type=Release --core-version 99999.99999 --clean-build
      
      - name: add site dir to pythonpath
        run: |
          python_user_site=`python -m site --user-site`
          echo "PYTHONPATH=${python_user_site}:$PYTHONPATH" >> "$GITHUB_ENV"
          python -c "import cyclus.lib as cyclib; print(cyclib.__file__)"
  
      - name: Cycamore Unit Tests
        run: |
          cycamore_unit_tests

      - name: Cycamore Python Tests
        run: |
          echo $PYTHONPATH
          cd tests && python -m pytest